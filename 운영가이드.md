# Multinic Operator 운영 가이드

## 1. 목적

OpenstackConfig CR을 기준으로 OpenStack 포트 정보를 수집하고,
Viola API로 노드별 Agent CR 생성 요청을 전송하는 오퍼레이터의 운영 방법을 정리한다.

## 2. 데이터 흐름

1) OpenstackConfig 변경 감지
2) Contrabass → Keystone → Neutron 순으로 인증/조회
3) subnetName 기준 포트 필터링
4) NodeConfig 변환 후 Viola API POST
5) Inventory API에 최신 상태 저장

## 3. 필수 입력

- `subnetName`: **서브넷 이름**
- `vmNames`: **VM ID(UUID)**
- `credentials.openstackProviderID`
- `credentials.projectID`

## 4. 기본 운영 확인

1) 컨트롤러 상태
```
kubectl -n multinic-operator-system get pods
kubectl -n multinic-operator-system logs deploy/multinic-operator-controller-manager --since=10m
```

2) Inventory API 확인
```
kubectl -n multinic-operator-system port-forward svc/multinic-operator-inventory-service 18081:18081
curl -s "http://127.0.0.1:18081/v1/inventory/node-configs?providerId=<provider-id>"
```

3) OpenstackConfig 상태
```
kubectl -n multinic-system get openstackconfig <name> -o yaml
```

## 5. Status Conditions 의미

- `Ready=True`: 동기화 성공 또는 변경 없음
- `Degraded=True`: 오류 상태
- `lastSyncedAt`: 마지막 성공 동기화 시각
- `lastError`: 마지막 오류 메시지

## 6. 흔한 오류와 대응

- `ContrabassError`
  - Contrabass API 접근/인증 문제
- `KeystoneError`
  - Keystone URL, 프로젝트 ID, 계정/암호 확인
- `NeutronEndpointError`
  - 서비스 카탈로그에 network endpoint 없음
  - `OPENSTACK_NEUTRON_ENDPOINT` 직접 지정 가능
- `NeutronSubnetError` / `SubnetNotFound`
  - `subnetName` 오타 또는 접근 권한 문제
- `NeutronPortError`
  - Neutron API 장애/과부하
- `ViolaPostError`
  - Viola API 장애/네트워크 경로 확인

### 6.1 오류 대응표

| Reason | 의미 | 조치 |
| --- | --- | --- |
| `ContrabassError` | Contrabass API 조회 실패 | Endpoint/인증/네트워크 확인 |
| `KeystoneError` | Keystone 토큰 발급 실패 | URL/Project ID/계정 확인 |
| `NeutronEndpointError` | Neutron endpoint 미발견 | 카탈로그 확인 또는 `OPENSTACK_NEUTRON_ENDPOINT` 지정 |
| `NeutronSubnetError` | 서브넷 조회 실패 | subnetName 오타/권한 확인 |
| `SubnetNotFound` | 서브넷 이름 미매칭 | 실제 서브넷 이름 재확인 |
| `NeutronPortError` | 포트 조회 실패 | Neutron 장애/부하 확인 |
| `ViolaPostError` | Viola 전송 실패 | Viola API 상태/네트워크 확인 |

## 7. 운영 팁

- 동일 이름 서브넷이 여러 개면 ID 오름차순 첫 번째를 사용한다.
- 오퍼레이터는 파일 기반 저장소 사용이므로 **1 replica 권장**.
- 강제 동기화가 필요하면 CR에 어노테이션을 추가한다.
```
kubectl -n multinic-system annotate openstackconfig <name> multinic.io/reconcile-at="$(date +%s)" --overwrite
```

## 8. Status 예시

```yaml
status:
  lastSyncedAt: "2026-01-09T06:23:29Z"
  lastError: ""
  conditions:
  - type: Ready
    status: "True"
    reason: "NoChange"
    message: "no changes detected"
    lastTransitionTime: "2026-01-09T06:07:36Z"
  - type: Degraded
    status: "False"
    reason: "Healthy"
    message: "controller healthy"
    lastTransitionTime: "2026-01-09T06:07:36Z"
```

## 9. Inventory API 응답 예시

```json
[
  {
    "providerId": "provider-uuid",
    "nodeName": "vm-uuid-1",
    "instanceId": "vm-uuid-1",
    "config": {
      "nodeName": "vm-uuid-1",
      "instanceId": "vm-uuid-1",
      "interfaces": [
        {
          "id": 1,
          "portId": "port-uuid",
          "macAddress": "fa:16:3e:aa:bb:cc",
          "address": "10.0.0.10",
          "cidr": "10.0.0.0/24",
          "mtu": 1450
        }
      ]
    }
  }
]
```
